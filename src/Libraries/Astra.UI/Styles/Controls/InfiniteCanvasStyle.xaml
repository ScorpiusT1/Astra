<ResourceDictionary xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                    xmlns:local="clr-namespace:Astra.UI.Controls"
                    xmlns:converters="clr-namespace:Astra.UI.Converters"
                    xmlns:models="clr-namespace:Astra.Core.Nodes.Models;assembly=Astra.Core">


    <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
    <converters:InvertedBooleanToVisibilityConverter x:Key="InvertedBooleanToVisibilityConverter" />
    <converters:PositionConverter x:Key="PositionConverter" />
    <converters:ExecutionResultToTimeConverter x:Key="ExecutionResultToTimeConverter" />

    <!-- InfiniteCanvas 默认样式 -->
    <Style TargetType="{x:Type local:InfiniteCanvas}">
        <!-- ✅ 使用 DynamicResource 动态绑定颜色 -->
        <Setter Property="Background"
                Value="{DynamicResource BackgroundBrush}" />
        <Setter Property="GridBrush"
                Value="{DynamicResource BorderBrush}" />
        <Setter Property="AlignmentLineBrush"
                Value="{DynamicResource SuccessBrush}" />
        <Setter Property="SelectionBorderBrush"
                Value="{DynamicResource PrimaryBrush}" />
        <Setter Property="ClipToBounds"
                Value="True" />
        <Setter Property="Focusable"
                Value="True" />
        
        <!-- 默认数据模板：使用 NodeControl，绑定 Node 类的属性 -->
        <Setter Property="ItemTemplate">
            <Setter.Value>
                <DataTemplate>
                    <local:NodeControl Title="{Binding Name, Mode=TwoWay, FallbackValue='节点'}"
                                      Status="{Binding ExecutionState, FallbackValue={x:Static models:NodeExecutionState.Idle}}"
                                      ExecutionTime="{Binding LastExecutionResult, Converter={StaticResource ExecutionResultToTimeConverter}, FallbackValue='0 s'}" />
                </DataTemplate>
            </Setter.Value>
        </Setter>

        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="{x:Type local:InfiniteCanvas}">
                    <Grid Background="{TemplateBinding Background}">
                        <!-- 网格层 -->
                        <Canvas x:Name="PART_GridLayer"
                                IsHitTestVisible="False"
                                Panel.ZIndex="0" />

                        <!-- 内容层 -->
                        <Canvas x:Name="PART_ContentCanvas"
                                Panel.ZIndex="1"
                                AllowDrop="True"
                                Background="Transparent">
                            <ItemsControl ItemsSource="{TemplateBinding ItemsSource}"
                                          ItemTemplate="{TemplateBinding ItemTemplate}"
                                          AllowDrop="True"
                                          Background="Transparent">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <Canvas />
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>

                                <ItemsControl.ItemContainerStyle>
                                    <Style TargetType="ContentPresenter">
                                        <!-- 绑定到 Position 属性，使用双向绑定模式 -->
                                        <Setter Property="Canvas.Left">
                                            <Setter.Value>
                                                <Binding Path="Position" Converter="{StaticResource PositionConverter}" ConverterParameter="X" Mode="OneWay" />
                                            </Setter.Value>
                                        </Setter>
                                        <Setter Property="Canvas.Top">
                                            <Setter.Value>
                                                <Binding Path="Position" Converter="{StaticResource PositionConverter}" ConverterParameter="Y" Mode="OneWay" />
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </ItemsControl.ItemContainerStyle>
                            </ItemsControl>
                        </Canvas>

                        <!-- 对齐辅助线层 -->
                        <Canvas x:Name="PART_AlignmentLayer"
                                IsHitTestVisible="False"
                                Panel.ZIndex="2" />

                        <!-- 缩略图容器 -->
                        <Grid HorizontalAlignment="Right"
                              VerticalAlignment="Bottom"
                              Margin="12"
                              Panel.ZIndex="10"
                              Visibility="{TemplateBinding ShowMinimap, Converter={StaticResource BooleanToVisibilityConverter}}">

                            <!-- 展开状态的完整缩略图 -->
                            <Border x:Name="PART_MinimapContainer"
                                    Width="{TemplateBinding MinimapWidth}"
                                    Height="{TemplateBinding MinimapHeight}"
                                    Background="{DynamicResource SurfaceBrush}"
                                    BorderBrush="{DynamicResource BorderBrush}"
                                    BorderThickness="1"
                                    CornerRadius="4"
                                    Visibility="{Binding IsMinimapCollapsed, RelativeSource={RelativeSource TemplatedParent}, Converter={StaticResource InvertedBooleanToVisibilityConverter}}">

                                <!-- 阴影效果 -->
                                <Border.Effect>
                                    <DropShadowEffect Color="{DynamicResource ShadowColor}"
                                                      BlurRadius="8"
                                                      ShadowDepth="2"
                                                      Opacity="0.15" />
                                </Border.Effect>

                                <!-- 缩略图内容 -->
                                <DockPanel>
                                    <!-- 标题栏 -->
                                    <Border DockPanel.Dock="Top"
                                            Height="32"
                                            Background="{DynamicResource SecondaryRegionBrush}"
                                            BorderBrush="{DynamicResource BorderBrush}"
                                            BorderThickness="0,0,0,1">
                                        <Grid>
                                            <TextBlock Text="缩略图"
                                                       Foreground="{DynamicResource PrimaryTextBrush}"
                                                       FontSize="12"
                                                       VerticalAlignment="Center"
                                                       Margin="8,0" />

                                            <!-- 折叠按钮（最小化图标） -->
                                            <Button x:Name="PART_MinimapCollapseButton"
                                                    HorizontalAlignment="Right"
                                                    Width="32"
                                                    Height="32"
                                                    Margin="4"
                                                    Padding="0"
                                                    Background="Transparent"
                                                    BorderThickness="0"
                                                    Cursor="Hand"
                                                    ToolTip="折叠缩略图">
                                                <Button.Content>
                                                    <Path Data="M5 12h14"
                                                          Stroke="{DynamicResource PrimaryTextBrush}"
                                                          StrokeThickness="1.5"
                                                          Stretch="Uniform"
                                                          Width="12"
                                                          Height="12"
                                                          HorizontalAlignment="Center"
                                                          VerticalAlignment="Center" />
                                                </Button.Content>
                                            </Button>
                                        </Grid>
                                    </Border>

                                    <!-- 画布缩略图 -->
                                    <Canvas x:Name="PART_MinimapCanvas"
                                            Background="{DynamicResource BackgroundBrush}">
                                        <!-- 视口指示器 - 显示当前可见区域 -->
                                        <Rectangle x:Name="PART_ViewportIndicator"
                                                   Stroke="{DynamicResource PrimaryBrush}"
                                                   StrokeThickness="2"
                                                   Fill="{DynamicResource PrimaryBrush}"
                                                   Opacity="0.3"
                                                   Panel.ZIndex="100"
                                                   IsHitTestVisible="False"
                                                   Visibility="Visible"
                                                   Width="20"
                                                   Height="20" />
                                    </Canvas>
                                </DockPanel>
                            </Border>

                            <!-- 折叠状态的小按钮（最大化图标） -->
                            <Button x:Name="PART_MinimapExpandButton"
                                    Width="28"
                                    Height="28"
                                    Padding="0"
                                    Background="Transparent"
                                    BorderThickness="0"
                                    Cursor="Hand"
                                    ToolTip="展开缩略图"
                                    Visibility="{Binding IsMinimapCollapsed, RelativeSource={RelativeSource TemplatedParent}, Converter={StaticResource BooleanToVisibilityConverter}}">

                                <Button.Content>
                                    <Border Width="28"
                                            Height="28"
                                            Background="{DynamicResource SurfaceBrush}"
                                            BorderBrush="{DynamicResource BorderBrush}"
                                            BorderThickness="1"
                                            CornerRadius="14">
                                        <Border.Effect>
                                            <DropShadowEffect Color="{DynamicResource ShadowColor}"
                                                              BlurRadius="4"
                                                              ShadowDepth="1"
                                                              Opacity="0.15" />
                                        </Border.Effect>

                                        <Path Data="M4 4h16v16H4V4z"
                                              Stroke="{DynamicResource PrimaryBrush}"
                                              StrokeThickness="1.5"
                                              Stretch="Uniform"
                                              Width="12"
                                              Height="12"
                                              HorizontalAlignment="Center"
                                              VerticalAlignment="Center" />
                                    </Border>
                                </Button.Content>
                            </Button>
                        </Grid>

                        <!-- 选择框 -->
                        <Rectangle x:Name="PART_SelectionBox"
                                   Stroke="{DynamicResource PrimaryBrush}"
                                   StrokeThickness="1.5"
                                   StrokeDashArray="4 2"
                                   Fill="{DynamicResource LightPrimaryBrush}"
                                   Opacity="0.25"
                                   Visibility="Collapsed"
                                   Panel.ZIndex="5" />

                        <!-- 状态栏 -->
                        <Border VerticalAlignment="Bottom"
                                HorizontalAlignment="Left"
                                Margin="12"
                                Padding="10,6"
                                Background="{DynamicResource SurfaceBrush}"
                                BorderBrush="{DynamicResource BorderBrush}"
                                BorderThickness="1"
                                CornerRadius="4"
                                Panel.ZIndex="10">

                            <Border.Effect>
                                <DropShadowEffect Color="{DynamicResource ShadowColor}"
                                                  BlurRadius="6"
                                                  ShadowDepth="1"
                                                  Opacity="0.1" />
                            </Border.Effect>

                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="缩放: "
                                           Foreground="{DynamicResource SecondaryTextBrush}"
                                           FontSize="11" />
                                <TextBlock Text="{Binding Scale, RelativeSource={RelativeSource TemplatedParent}, StringFormat={}{0:P0}}"
                                           Foreground="{DynamicResource PrimaryTextBrush}"
                                           FontSize="11"
                                           FontWeight="Medium" />

                                <Rectangle Width="1"
                                           Height="12"
                                           Fill="{DynamicResource BorderBrush}"
                                           Margin="8,0" />

                                <TextBlock Text="节点: "
                                           Foreground="{DynamicResource SecondaryTextBrush}"
                                           FontSize="11" />
                                <TextBlock x:Name="PART_NodeCountText"
                                           Text="0"
                                           Foreground="{DynamicResource PrimaryTextBrush}"
                                           FontSize="11"
                                           FontWeight="Medium" />
                            </StackPanel>
                        </Border>
                    </Grid>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>
</ResourceDictionary>