<ResourceDictionary xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                    xmlns:local="clr-namespace:Astra.UI.Controls"
                    xmlns:converters="clr-namespace:Astra.UI.Converters"
                    xmlns:models="clr-namespace:Astra.Core.Nodes.Models;assembly=Astra.Core">


    <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
    <converters:InvertedBooleanToVisibilityConverter x:Key="InvertedBooleanToVisibilityConverter" />
    <converters:PositionConverter x:Key="PositionConverter" />
    <converters:ExecutionResultToTimeConverter x:Key="ExecutionResultToTimeConverter" />

    <!-- InfiniteCanvas 默认样式 -->
    <Style TargetType="{x:Type local:InfiniteCanvas}">
        <!-- ✅ 使用 DynamicResource 动态绑定颜色 -->
        <Setter Property="Background"
                Value="{DynamicResource BackgroundBrush}" />
        <Setter Property="GridBrush"
                Value="{DynamicResource BorderBrush}" />
        <Setter Property="AlignmentLineBrush"
                Value="{DynamicResource SuccessBrush}" />
        <Setter Property="SelectionBorderBrush"
                Value="{DynamicResource PrimaryBrush}" />
        <Setter Property="ClipToBounds"
                Value="True" />
        <Setter Property="Focusable"
                Value="True" />
        
        <!-- 默认数据模板：使用 NodeControl，绑定 Node 类的属性 -->
        <Setter Property="ItemTemplate">
            <Setter.Value>
                <DataTemplate>
                    <local:NodeControl Title="{Binding Name, Mode=TwoWay, FallbackValue='节点'}"
                                      Status="{Binding ExecutionState, FallbackValue={x:Static models:NodeExecutionState.Idle}}"
                                      ExecutionTime="{Binding LastExecutionResult, Converter={StaticResource ExecutionResultToTimeConverter}, FallbackValue='0 s'}" 
                                      IsSelected="{Binding IsSelected, Mode=TwoWay}" />
                </DataTemplate>
            </Setter.Value>
        </Setter>

        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="{x:Type local:InfiniteCanvas}">
                    <!-- 使用 Border 作为最外层，确保整个区域能接收鼠标事件与拖放 -->
                    <Border Background="{TemplateBinding Background}"
                            AllowDrop="True">
                        <Grid>
                            <!-- 网格层 -->
                            <Canvas x:Name="PART_GridLayer"
                                    IsHitTestVisible="False"
                                    Panel.ZIndex="0" />

                            <!-- 内容层 -->
                            <Canvas x:Name="PART_ContentCanvas"
                                    Panel.ZIndex="1"
                                    AllowDrop="True"
                                    Background="Transparent">
                            <local:TemplateSelectorItemsControl ItemsSource="{TemplateBinding ItemsSource}"
                                          ItemTemplateSelector="{TemplateBinding ItemTemplateSelector}"
                                          x:Name="PART_ItemsControl"
                                          AllowDrop="True">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <Canvas />
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>

                                <ItemsControl.ItemContainerStyle>
                                    <Style TargetType="ContentPresenter">
                                        <!-- 绑定到 Position 属性，使用双向绑定模式 -->
                                        <Setter Property="Canvas.Left">
                                            <Setter.Value>
                                                <Binding Path="Position" Converter="{StaticResource PositionConverter}" ConverterParameter="X" Mode="OneWay" />
                                            </Setter.Value>
                                        </Setter>
                                        <Setter Property="Canvas.Top">
                                            <Setter.Value>
                                                <Binding Path="Position" Converter="{StaticResource PositionConverter}" ConverterParameter="Y" Mode="OneWay" />
                                            </Setter.Value>
                                        </Setter>
                                    </Style>
                                </ItemsControl.ItemContainerStyle>
                            </local:TemplateSelectorItemsControl>
                        </Canvas>

                        <!-- 对齐辅助线层 -->
                        <Canvas x:Name="PART_AlignmentLayer"
                                IsHitTestVisible="False"
                                Panel.ZIndex="2" />

                        <!-- 缩略图容器 -->
                        <Grid HorizontalAlignment="Right"
                              VerticalAlignment="Bottom"
                              Margin="12"
                              Panel.ZIndex="10"
                              IsHitTestVisible="True"
                              Visibility="{TemplateBinding ShowMinimap, Converter={StaticResource BooleanToVisibilityConverter}}">

                            <!-- 展开状态的完整缩略图 -->
                            <Border x:Name="PART_MinimapContainer"
                                    Width="{TemplateBinding MinimapWidth}"
                                    Height="{TemplateBinding MinimapHeight}"
                                    Background="{DynamicResource SurfaceBrush}"
                                    BorderBrush="{DynamicResource BorderBrush}"
                                    BorderThickness="1"
                                    CornerRadius="4"
                                    IsHitTestVisible="True"
                                    Focusable="True"
                                    FocusVisualStyle="{x:Null}"
                                    Visibility="{Binding IsMinimapCollapsed, RelativeSource={RelativeSource TemplatedParent}, Converter={StaticResource InvertedBooleanToVisibilityConverter}}">

                                <!-- 阴影效果 -->
                                <Border.Effect>
                                    <DropShadowEffect Color="{DynamicResource ShadowColor}"
                                                      BlurRadius="8"
                                                      ShadowDepth="2"
                                                      Opacity="0.15" />
                                </Border.Effect>

                                <!-- 缩略图内容 -->
                                <DockPanel>
                                    <!-- 标题栏 -->
                                    <Border DockPanel.Dock="Top"
                                            Height="32"
                                            Background="{DynamicResource SecondaryRegionBrush}"
                                            BorderBrush="{DynamicResource BorderBrush}"
                                            BorderThickness="0,0,0,1">
                                        <Grid>
                                            <TextBlock Text="缩略图"
                                                       Foreground="{DynamicResource PrimaryTextBrush}"
                                                       FontSize="12"
                                                       VerticalAlignment="Center"
                                                       Margin="8,0" />

                                            <StackPanel Orientation="Horizontal"
                                                       HorizontalAlignment="Right">
                                                <!-- 适应画布按钮 -->
                                                <Button x:Name="PART_MinimapFitButton"
                                                        Width="28"
                                                        Height="28"
                                                        Margin="2"
                                                        Padding="0"
                                                        Background="Transparent"
                                                        BorderThickness="0"
                                                        Cursor="Hand"
                                                        ToolTip="适应画布 (Fit to Screen)">
                                                    <Button.Content>
                                                        <Path Data="M4 4h4v4M20 4h-4v4M20 20h-4v-4M4 20h4v-4"
                                                              Stroke="{DynamicResource PrimaryTextBrush}"
                                                              StrokeThickness="1.5"
                                                              Stretch="Uniform"
                                                              Width="14"
                                                              Height="14"
                                                              HorizontalAlignment="Center"
                                                              VerticalAlignment="Center" />
                                                    </Button.Content>
                                                </Button>

                                                <!-- 折叠按钮（最小化图标） -->
                                                <Button x:Name="PART_MinimapCollapseButton"
                                                        Width="28"
                                                        Height="28"
                                                        Margin="2,2,4,2"
                                                        Padding="0"
                                                        Background="Transparent"
                                                        BorderThickness="0"
                                                        Cursor="Hand"
                                                        ToolTip="折叠缩略图">
                                                    <Button.Content>
                                                        <Path Data="M5 12h14"
                                                              Stroke="{DynamicResource PrimaryTextBrush}"
                                                              StrokeThickness="1.5"
                                                              Stretch="Uniform"
                                                              Width="12"
                                                              Height="12"
                                                              HorizontalAlignment="Center"
                                                              VerticalAlignment="Center" />
                                                    </Button.Content>
                                                </Button>
                                            </StackPanel>
                                        </Grid>
                                    </Border>

                                    <!-- 画布缩略图 -->
                                    <Canvas x:Name="PART_MinimapCanvas"
                                            Background="{DynamicResource BackgroundBrush}"
                                            ClipToBounds="True"
                                            Margin="1"
                                            IsHitTestVisible="True"
                                            FocusVisualStyle="{x:Null}"
                                            Focusable="True">
                                      
                                        
                                        <!-- 视口指示器 - 使用 Thumb 控件实现拖拽（横着的长方形样式） -->
                                        <Thumb x:Name="PART_ViewportIndicator"
                                               Panel.ZIndex="1000"
                                               Cursor="Hand"
                                               Background="Transparent"
                                               Opacity="1.0">
                                            <Thumb.Template>
                                                <ControlTemplate TargetType="Thumb">
                                                    <Border x:Name="ThumbBorder"
                                                            Background="{DynamicResource PrimaryBrush}"
                                                            BorderBrush="{DynamicResource PrimaryBrush}"
                                                            BorderThickness="2"
                                                            CornerRadius="3"
                                                            Opacity="0.3"
                                                            IsHitTestVisible="True">
                                                        <Border.Effect>
                                                            <DropShadowEffect Color="{DynamicResource PrimaryColor}"
                                                                              BlurRadius="6"
                                                                              ShadowDepth="0"
                                                                              Opacity="0.4" />
                                                        </Border.Effect>
                                                    </Border>
                                                    <ControlTemplate.Triggers>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter TargetName="ThumbBorder" Property="Opacity" Value="0.5"/>
                                                            <Setter TargetName="ThumbBorder" Property="BorderThickness" Value="2.5"/>
                                                        </Trigger>
                                                        <Trigger Property="IsDragging" Value="True">
                                                            <Setter TargetName="ThumbBorder" Property="Opacity" Value="0.7"/>
                                                            <Setter TargetName="ThumbBorder" Property="BorderThickness" Value="3"/>
                                                            <Setter Property="Cursor" Value="SizeAll"/>
                                                        </Trigger>
                                                    </ControlTemplate.Triggers>
                                                </ControlTemplate>
                                            </Thumb.Template>
                                            <Thumb.ToolTip>
                                                <ToolTip Content="拖拽以移动视口" 
                                                         FontWeight="Bold"
                                                         Background="{DynamicResource InfoBrush}"
                                                         Foreground="White"/>
                                            </Thumb.ToolTip>
                                        </Thumb>
                                    </Canvas>
                                </DockPanel>
                            </Border>

                            <!-- 折叠状态的小按钮（最大化图标） -->
                            <Button x:Name="PART_MinimapExpandButton"
                                    Width="28"
                                    Height="28"
                                    Padding="0"
                                    Background="Transparent"
                                    BorderThickness="0"
                                    Cursor="Hand"
                                    IsHitTestVisible="True"
                                    ToolTip="展开缩略图"
                                    Visibility="{Binding IsMinimapCollapsed, RelativeSource={RelativeSource TemplatedParent}, Converter={StaticResource BooleanToVisibilityConverter}}">

                                <Button.Content>
                                    <Border Width="28"
                                            Height="28"
                                            Background="{DynamicResource SurfaceBrush}"
                                            BorderBrush="{DynamicResource BorderBrush}"
                                            BorderThickness="1"
                                            CornerRadius="14">
                                        <Border.Effect>
                                            <DropShadowEffect Color="{DynamicResource ShadowColor}"
                                                              BlurRadius="4"
                                                              ShadowDepth="1"
                                                              Opacity="0.15" />
                                        </Border.Effect>

                                        <Path Data="M4 4h16v16H4V4z"
                                              Stroke="{DynamicResource PrimaryBrush}"
                                              StrokeThickness="1.5"
                                              Stretch="Uniform"
                                              Width="12"
                                              Height="12"
                                              HorizontalAlignment="Center"
                                              VerticalAlignment="Center" />
                                    </Border>
                                </Button.Content>
                            </Button>
                        </Grid>

                        <!-- 选择框层：使用 Canvas 使 Canvas.SetLeft/Top 生效 -->
                        <Canvas Panel.ZIndex="5"
                                IsHitTestVisible="True">
                            <!-- 框选进行中的橡皮筋 -->
                            <Rectangle x:Name="PART_SelectionBox"
                                       Stroke="{DynamicResource PrimaryBrush}"
                                       StrokeThickness="1.5"
                                       StrokeDashArray="4 2"
                                       Fill="{DynamicResource LightPrimaryBrush}"
                                       Opacity="0.25"
                                       Visibility="Collapsed"
                                       IsHitTestVisible="False" />
                            <!-- 框选完成后选中范围高亮 -->
                            <Rectangle x:Name="PART_SelectedGroupBox"
                                       Stroke="{DynamicResource PrimaryBrush}"
                                       StrokeThickness="2.2"
                                       StrokeDashArray="6 4"
                                       Fill="{DynamicResource LightPrimaryBrush}"
                                       Opacity="0.18"
                                       RadiusX="4"
                                       RadiusY="4"
                                       Visibility="Collapsed"
                                       IsHitTestVisible="True" />
                        </Canvas>

                        <!-- 状态栏 -->
                        <Border VerticalAlignment="Bottom"
                                HorizontalAlignment="Center"
                                Margin="12"
                                Padding="10,6"
                                Background="{DynamicResource SurfaceBrush}"
                                BorderBrush="{DynamicResource BorderBrush}"
                                BorderThickness="1"
                                CornerRadius="4"
                                IsHitTestVisible="False"
                                Panel.ZIndex="10">

                            <Border.Effect>
                                <DropShadowEffect Color="{DynamicResource ShadowColor}"
                                                  BlurRadius="6"
                                                  ShadowDepth="1"
                                                  Opacity="0.1" />
                            </Border.Effect>

                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="缩放: "
                                           Foreground="{DynamicResource SecondaryTextBrush}"
                                           FontSize="11" />
                                <TextBlock Text="{Binding Scale, RelativeSource={RelativeSource TemplatedParent}, StringFormat={}{0:P0}}"
                                           Foreground="{DynamicResource PrimaryTextBrush}"
                                           FontSize="11"
                                           FontWeight="Medium" />

                                <Rectangle Width="1"
                                           Height="12"
                                           Fill="{DynamicResource BorderBrush}"
                                           Margin="8,0" />

                                <TextBlock Text="节点: "
                                           Foreground="{DynamicResource SecondaryTextBrush}"
                                           FontSize="11" />
                                <TextBlock Text="{Binding TotalItemsCount, RelativeSource={RelativeSource TemplatedParent}}"
                                           Foreground="{DynamicResource PrimaryTextBrush}"
                                           FontSize="11"
                                           FontWeight="Medium" />

                                <Rectangle Width="1"
                                           Height="12"
                                           Fill="{DynamicResource BorderBrush}"
                                           Margin="8,0" />

                                <TextBlock Text="已选中: "
                                           Foreground="{DynamicResource SecondaryTextBrush}"
                                           FontSize="11" />
                                <TextBlock Text="{Binding SelectedItemsCount, RelativeSource={RelativeSource TemplatedParent}}"
                                           Foreground="{DynamicResource PrimaryTextBrush}"
                                           FontSize="11"
                                           FontWeight="Medium" />
                            </StackPanel>
                        </Border>
                        </Grid>
                    </Border>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>
</ResourceDictionary>