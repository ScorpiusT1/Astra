<ResourceDictionary xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                    xmlns:controls="clr-namespace:Astra.UI.Controls"
                    xmlns:ui="clr-namespace:Astra.UI.Controls;assembly=Astra.UI">

    <ResourceDictionary.MergedDictionaries>
        <!-- 引入转换器资源（确保模板中可以使用） -->
        <ResourceDictionary Source="../../Themes/Converters.xaml" />
    </ResourceDictionary.MergedDictionaries>

    <!-- ==================== 辅助转换器 ==================== -->
    <!-- 转换器已移动到 Themes/Converters.xaml，通过 Controls.xaml 引入 -->

    <!-- ==================== 阴影效果资源 ==================== -->
    <DropShadowEffect x:Key="LightShadow"
                      Color="{DynamicResource ShadowColor}"
                      Opacity="0.12"
                      BlurRadius="8"
                      ShadowDepth="2"
                      Direction="270" />

    <!-- ==================== WorkflowTabControl 默认样式 ==================== -->
    <Style TargetType="{x:Type controls:WorkflowTabControl}">
        <Setter Property="Background"
                Value="Transparent" />
        <Setter Property="BorderThickness"
                Value="0" />
        <Setter Property="Padding"
                Value="0" />
        <Setter Property="HorizontalAlignment"
                Value="Stretch" />
        <Setter Property="VerticalAlignment"
                Value="Stretch" />
        <Setter Property="HorizontalContentAlignment"
                Value="Stretch" />
        <Setter Property="VerticalContentAlignment"
                Value="Stretch" />
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="{x:Type controls:WorkflowTabControl}">
                    <Grid SnapsToDevicePixels="True"
                          ClipToBounds="True">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto" />
                            <RowDefinition Height="*" />
                        </Grid.RowDefinitions>

                        <!-- 标题栏区域 -->
                        <Grid Grid.Row="0">
                            <Border Background="{DynamicResource SecondaryRegionBrush}"
                                    BorderBrush="{DynamicResource BorderBrush}"
                                    BorderThickness="{TemplateBinding BorderThickness}">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <!-- 主流程按钮 -->
                                        <ColumnDefinition Width="Auto" />
                                        <!-- TabPanel（标签页列表） -->
                                        <ColumnDefinition Width="*" />
                                        <!-- 标题列表按钮和添加按钮 -->
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <!-- 主流程按钮 -->
                                    <Button x:Name="PART_MasterWorkflowButton"
                                            Grid.Column="0"
                                            Content="{TemplateBinding MasterWorkflowButtonContent}"
                                            ToolTip="{TemplateBinding MasterWorkflowButtonToolTip}"
                                            Background="Transparent"
                                            BorderThickness="0"
                                            Padding="12,8"
                                            Margin="4,0,4,0"
                                            VerticalAlignment="Center"
                                            Cursor="Hand"
                                            FocusVisualStyle="{x:Null}"
                                            Visibility="{TemplateBinding ShowMasterWorkflowButton, Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <Button.Style>
                                            <Style TargetType="Button">
                                                <Setter Property="Background"
                                                        Value="Transparent" />
                                                <Setter Property="Foreground"
                                                        Value="{DynamicResource PrimaryTextBrush}" />
                                                <Style.Triggers>
                                                    <Trigger Property="IsMouseOver"
                                                             Value="True">
                                                        <Setter Property="Background"
                                                                Value="{DynamicResource SecondaryRegionBrush}" />
                                                    </Trigger>
                                                </Style.Triggers>
                                            </Style>
                                        </Button.Style>
                                    </Button>

                                    <!-- TabPanel（标签页列表） -->
                                    <Border Grid.Column="1"
                                            BorderBrush="{DynamicResource BorderBrush}"
                                            BorderThickness="1"
                                            VerticalAlignment="Stretch"
                                            Visibility="{TemplateBinding ShowTabPanel, Converter={StaticResource BooleanToVisibilityConverter}}">
                                        <ScrollViewer HorizontalScrollBarVisibility="Auto"
                                                      VerticalScrollBarVisibility="Disabled"
                                                      VerticalAlignment="Stretch"
                                                      Focusable="False"
                                                      CanContentScroll="False"
                                                      PanningMode="HorizontalOnly">
                                            <TabPanel x:Name="HeaderPanel"
                                                      IsItemsHost="True"
                                                      Background="Transparent"
                                                      VerticalAlignment="Center"
                                                      KeyboardNavigation.TabIndex="1"
                                                      KeyboardNavigation.TabNavigation="Once"
                                                      KeyboardNavigation.DirectionalNavigation="None" />
                                        </ScrollViewer>
                                    </Border>

                                    <!-- 添加按钮和标题列表按钮 -->
                                    <StackPanel Grid.Column="2"
                                                Orientation="Horizontal"
                                                VerticalAlignment="Center"
                                                HorizontalAlignment="Right"
                                                Margin="4,0">
                                        <!-- 添加按钮 -->
                                        <Button x:Name="PART_AddButton"
                                                ToolTip="{TemplateBinding AddButtonToolTip}"
                                                Width="32"
                                                Height="32"
                                                VerticalAlignment="Center"
                                                HorizontalAlignment="Center"
                                                Margin="0,0,4,0"
                                                Cursor="Hand"
                                                FocusVisualStyle="{x:Null}"
                                                Visibility="{TemplateBinding ShowAddButton, Converter={StaticResource BooleanToVisibilityConverter}}">
                                            <Button.Content>
                                                <!-- 使用 TextBlock 显示更大的 "+" 号 -->
                                                <TextBlock Text="+"
                                                          FontSize="20"
                                                          FontWeight="Bold"
                                                          Foreground="{DynamicResource PrimaryTextBrush}"
                                                          HorizontalAlignment="Center"
                                                          VerticalAlignment="Center"
                                                          TextAlignment="Center" />
                                            </Button.Content>
                                            <Button.Style>
                                                <Style TargetType="Button">
                                                    <Setter Property="Background"
                                                            Value="Transparent" />
                                                    <Setter Property="BorderThickness"
                                                            Value="0" />
                                                    <Setter Property="Template">
                                                        <Setter.Value>
                                                            <ControlTemplate TargetType="Button">
                                                                <Border Background="{TemplateBinding Background}"
                                                                        BorderBrush="{TemplateBinding BorderBrush}"
                                                                        BorderThickness="{TemplateBinding BorderThickness}"
                                                                        CornerRadius="6"
                                                                        Padding="0">
                                                                    <ContentPresenter HorizontalAlignment="Center"
                                                                                      VerticalAlignment="Center"
                                                                                      Content="{TemplateBinding Content}" />
                                                                </Border>
                                                            </ControlTemplate>
                                                        </Setter.Value>
                                                    </Setter>
                                                    <Style.Triggers>
                                                        <Trigger Property="IsMouseOver"
                                                                 Value="True">
                                                            <Setter Property="Background"
                                                                    Value="{DynamicResource SecondaryRegionBrush}" />
                                                        </Trigger>
                                                        <Trigger Property="IsPressed"
                                                                 Value="True">
                                                            <Setter Property="Background"
                                                                    Value="{DynamicResource ThirdlyRegionBrush}" />
                                                        </Trigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Button.Style>
                                        </Button>

                                        <!-- 标题列表按钮 -->
                                        <Button x:Name="PART_TabListButton"
                                                ToolTip="{TemplateBinding TabListButtonToolTip}"
                                                Width="32"
                                                Height="32"
                                                VerticalAlignment="Center"
                                                HorizontalAlignment="Center"
                                                Cursor="Hand"
                                                FocusVisualStyle="{x:Null}"
                                                Visibility="{TemplateBinding ShowTabListButton, Converter={StaticResource BooleanToVisibilityConverter}}">
                                            <Button.Content>
                                                <!-- 使用 Path 绘制非实心向下箭头 -->
                                                <Path Data="M 0 2 L 4 6 L 8 2" 
                                                      Stroke="{DynamicResource PrimaryTextBrush}" 
                                                      StrokeThickness="2" 
                                                      StrokeStartLineCap="Round"
                                                      StrokeEndLineCap="Round"
                                                      StrokeLineJoin="Round"
                                                      Stretch="Uniform" 
                                                      HorizontalAlignment="Center" 
                                                      VerticalAlignment="Center"
                                                      Width="10"
                                                      Height="10"
                                                      RenderTransformOrigin="0.5,0.5">
                                                    <Path.RenderTransform>
                                                        <TranslateTransform X="0" Y="0" />
                                                    </Path.RenderTransform>
                                                </Path>
                                            </Button.Content>
                                            <Button.Style>
                                                <Style TargetType="Button">
                                                    <Setter Property="Background"
                                                            Value="Transparent" />
                                                    <Setter Property="BorderThickness"
                                                            Value="0" />
                                                    <Setter Property="Template">
                                                        <Setter.Value>
                                                            <ControlTemplate TargetType="Button">
                                                                <Border Background="{TemplateBinding Background}"
                                                                        BorderBrush="{TemplateBinding BorderBrush}"
                                                                        BorderThickness="{TemplateBinding BorderThickness}"
                                                                        CornerRadius="6"
                                                                        Padding="0">
                                                                    <ContentPresenter HorizontalAlignment="Center"
                                                                                      VerticalAlignment="Center"
                                                                                      Content="{TemplateBinding Content}" />
                                                                </Border>
                                                            </ControlTemplate>
                                                        </Setter.Value>
                                                    </Setter>
                                                    <Style.Triggers>
                                                        <Trigger Property="IsMouseOver"
                                                                 Value="True">
                                                            <Setter Property="Background"
                                                                    Value="{DynamicResource SecondaryRegionBrush}" />
                                                        </Trigger>
                                                        <Trigger Property="IsPressed"
                                                                 Value="True">
                                                            <Setter Property="Background"
                                                                    Value="{DynamicResource ThirdlyRegionBrush}" />
                                                        </Trigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Button.Style>
                                        </Button>
                                    </StackPanel>

                                    <!-- 标题列表下拉菜单 -->
                                    <Popup x:Name="PART_TabListPopup"
                                           Placement="Bottom"
                                           PlacementTarget="{Binding ElementName=PART_TabListButton}"
                                           StaysOpen="False"
                                           PopupAnimation="Fade"
                                           AllowsTransparency="True">
                                        <Border Background="{DynamicResource SurfaceBrush}"
                                                BorderBrush="{DynamicResource BorderBrush}"
                                                BorderThickness="1"
                                                CornerRadius="6"
                                                Padding="2"
                                                MaxHeight="400"
                                                MinWidth="220"
                                                MaxWidth="320"
                                                Effect="{DynamicResource LightShadow}">
                                            <ScrollViewer VerticalScrollBarVisibility="Auto"
                                                          HorizontalScrollBarVisibility="Disabled"
                                                          Style="{DynamicResource ScrollViewerStyle}">
                                                <Grid>
                                                    <!-- 占位符：当没有元素时显示，确保最小高度 -->
                                                    <Border x:Name="EmptyPlaceholder"
                                                            Height="60"
                                                            Visibility="Collapsed" />
                                                    
                                                    <ItemsControl x:Name="PART_TabListItemsControl"
                                                                  Background="Transparent">
                                                        <ItemsControl.ItemContainerStyle>
                                                            <Style TargetType="ContentPresenter">
                                                                <Setter Property="HorizontalAlignment"
                                                                        Value="Stretch" />
                                                                <Setter Property="Margin"
                                                                        Value="2,1" />
                                                            </Style>
                                                        </ItemsControl.ItemContainerStyle>
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate>
                                                            <Button Background="Transparent"
                                                                    BorderThickness="0"
                                                                    Padding="16,10"
                                                                    HorizontalAlignment="Stretch"
                                                                    HorizontalContentAlignment="Left"
                                                                    Cursor="Hand"
                                                                    FocusVisualStyle="{x:Null}">
                                                                <Button.Content>
                                                                    <Grid>
                                                                        <Grid.ColumnDefinitions>
                                                                            <ColumnDefinition Width="Auto" />
                                                                            <ColumnDefinition Width="*" />
                                                                            <ColumnDefinition Width="Auto" />
                                                                        </Grid.ColumnDefinitions>
                                                                        
                                                                        <!-- 选中指示器 -->
                                                                        <Ellipse Grid.Column="0"
                                                                                 Width="6"
                                                                                 Height="6"
                                                                                 Margin="0,0,12,0"
                                                                                 VerticalAlignment="Center"
                                                                                 Fill="{DynamicResource PrimaryBrush}">
                                                                            <Ellipse.Style>
                                                                                <Style TargetType="Ellipse">
                                                                                    <Setter Property="Opacity"
                                                                                            Value="0" />
                                                                                    <Style.Triggers>
                                                                                        <!-- 通过 Button 的 Tag 获取选中状态 -->
                                                                                        <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=Button}, Path=Tag.IsSelected}"
                                                                                                     Value="True">
                                                                                            <Setter Property="Opacity"
                                                                                                    Value="1" />
                                                                                        </DataTrigger>
                                                                                        <!-- 或者通过附加属性 -->
                                                                                        <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=Button}, Path=(controls:WorkflowTabControl.IsTabListItemSelected)}"
                                                                                                     Value="True">
                                                                                            <Setter Property="Opacity"
                                                                                                    Value="1" />
                                                                                        </DataTrigger>
                                                                                    </Style.Triggers>
                                                                                </Style>
                                                                            </Ellipse.Style>
                                                                        </Ellipse>
                                                                        
                                                                        <!-- 流程名称 -->
                                                                        <TextBlock x:Name="textBlock"
                                                                                   Grid.Column="1"
                                                                                   Text="{Binding Name}"
                                                                                   FontSize="13"
                                                                                   Foreground="{DynamicResource PrimaryTextBrush}"
                                                                                   TextTrimming="CharacterEllipsis"
                                                                                   VerticalAlignment="Center">
                                                                            <TextBlock.Style>
                                                                                <Style TargetType="TextBlock">
                                                                                    <Setter Property="FontWeight"
                                                                                            Value="Normal" />
                                                                                    <Style.Triggers>
                                                                                        <!-- 通过 Tag 获取选中状态 -->
                                                                                        <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=Button}, Path=Tag.IsSelected}"
                                                                                                     Value="True">
                                                                                            <Setter Property="FontWeight"
                                                                                                    Value="Medium" />
                                                                                            <Setter Property="Foreground"
                                                                                                    Value="{DynamicResource PrimaryBrush}" />
                                                                                        </DataTrigger>
                                                                                        <!-- 通过附加属性获取选中状态 -->
                                                                                        <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=Button}, Path=(controls:WorkflowTabControl.IsTabListItemSelected)}"
                                                                                                     Value="True">
                                                                                            <Setter Property="FontWeight"
                                                                                                    Value="Medium" />
                                                                                            <Setter Property="Foreground"
                                                                                                    Value="{DynamicResource PrimaryBrush}" />
                                                                                        </DataTrigger>
                                                                                    </Style.Triggers>
                                                                                </Style>
                                                                            </TextBlock.Style>
                                                                        </TextBlock>
                                                                    </Grid>
                                                                </Button.Content>
                                                                <Button.Style>
                                                                    <Style TargetType="Button">
                                                                        <Setter Property="Background"
                                                                                Value="Transparent" />
                                                                        <Setter Property="Foreground"
                                                                                Value="{DynamicResource PrimaryTextBrush}" />
                                                                        <Setter Property="Template">
                                                                            <Setter.Value>
                                                                                <ControlTemplate TargetType="Button">
                                                                                    <Border x:Name="border"
                                                                                            Background="{TemplateBinding Background}"
                                                                                            BorderThickness="0"
                                                                                            CornerRadius="4"
                                                                                            Padding="{TemplateBinding Padding}">
                                                                                        <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                                                                                          VerticalAlignment="{TemplateBinding VerticalContentAlignment}"
                                                                                                          Content="{TemplateBinding Content}" />
                                                                                    </Border>
                                                                                    <ControlTemplate.Triggers>
                                                                                        <!-- 按下状态（优先级最高，覆盖所有其他状态） -->
                                                                                        <Trigger Property="IsPressed"
                                                                                                 Value="True">
                                                                                            <Setter TargetName="border"
                                                                                                    Property="Background"
                                                                                                    Value="{DynamicResource ThirdlyRegionBrush}" />
                                                                                        </Trigger>
                                                                                        <!-- 悬停状态（非选中时，优先级高于选中状态） -->
                                                                                        <MultiTrigger>
                                                                                            <MultiTrigger.Conditions>
                                                                                                <Condition Property="IsMouseOver"
                                                                                                           Value="True" />
                                                                                                <Condition Property="IsPressed"
                                                                                                           Value="False" />
                                                                                                <Condition Property="controls:WorkflowTabControl.IsTabListItemSelected"
                                                                                                           Value="False" />
                                                                                            </MultiTrigger.Conditions>
                                                                                            <Setter TargetName="border"
                                                                                                    Property="Background"
                                                                                                    Value="{DynamicResource SecondaryRegionBrush}" />
                                                                                        </MultiTrigger>
                                                                                        <!-- 悬停状态（选中时，优先级高于选中状态） -->
                                                                                        <MultiTrigger>
                                                                                            <MultiTrigger.Conditions>
                                                                                                <Condition Property="IsMouseOver"
                                                                                                           Value="True" />
                                                                                                <Condition Property="IsPressed"
                                                                                                           Value="False" />
                                                                                                <Condition Property="controls:WorkflowTabControl.IsTabListItemSelected"
                                                                                                           Value="True" />
                                                                                            </MultiTrigger.Conditions>
                                                                                            <Setter TargetName="border"
                                                                                                    Property="Background"
                                                                                                    Value="{DynamicResource SecondaryRegionBrush}" />
                                                                                        </MultiTrigger>
                                                                                        <!-- 选中状态（基础状态，在没有悬停和按下时显示） -->
                                                                                        <Trigger Property="controls:WorkflowTabControl.IsTabListItemSelected"
                                                                                                 Value="True">
                                                                                            <Setter TargetName="border"
                                                                                                    Property="Background"
                                                                                                    Value="{DynamicResource ThirdlyRegionBrush}" />
                                                                                        </Trigger>
                                                                                    </ControlTemplate.Triggers>
                                                                                </ControlTemplate>
                                                                            </Setter.Value>
                                                                        </Setter>
                                                                        <Style.Triggers>
                                                                            <!-- 选中状态 - 文字样式 -->
                                                                            <Trigger Property="controls:WorkflowTabControl.IsTabListItemSelected"
                                                                                     Value="True">
                                                                                <Setter Property="Foreground"
                                                                                        Value="{DynamicResource PrimaryTextBrush}" />
                                                                            </Trigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </Button.Style>
                                                            </Button>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>
                                                </Grid>
                                            </ScrollViewer>
                                        </Border>
                                    </Popup>
                                </Grid>
                            </Border>
                        </Grid>

                        <!-- 内容区域 - 使用 ItemsControl 保持所有内容加载，避免切换时重绘 -->
                        <Grid Grid.Row="1"
                              x:Name="PART_ContentHost"
                              Visibility="{TemplateBinding ShowContent, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <ItemsControl ItemsSource="{Binding RelativeSource={RelativeSource TemplatedParent}, Path=ItemsSource}"
                                          HorizontalAlignment="Stretch"
                                          VerticalAlignment="Stretch">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <Grid />
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Grid HorizontalAlignment="Stretch"
                                              VerticalAlignment="Stretch">
                                            <Grid.Style>
                                                <Style TargetType="Grid">
                                                    <Setter Property="Visibility" Value="Collapsed" />
                                                    <Setter Property="IsHitTestVisible" Value="False" />
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding IsActive}" Value="True">
                                                            <Setter Property="Visibility" Value="Visible" />
                                                            <Setter Property="IsHitTestVisible" Value="True" />
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Grid.Style>
                                            <ContentPresenter Content="{Binding}"
                                                              ContentTemplate="{Binding Path=ContentTemplate, RelativeSource={RelativeSource AncestorType={x:Type TabControl}}}" />
                                        </Grid>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </Grid>
                    </Grid>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>

</ResourceDictionary>

