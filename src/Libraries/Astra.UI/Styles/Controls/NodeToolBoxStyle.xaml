<ResourceDictionary xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                    xmlns:controls="clr-namespace:Astra.UI.Controls"
                    xmlns:converters="clr-namespace:Astra.UI.Converters"
                    xmlns:System="clr-namespace:System;assembly=mscorlib"
                    xmlns:fa="http://schemas.awesome.incremented/wpf/xaml/fontawesome.sharp">


    <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />

    <!-- 简单的布尔值到字符串转换器 -->
    <converters:BooleanToStringConverter x:Key="BooleanToStringConverter" />

    <!-- 图标代码转换器 -->
    <converters:IconConverter x:Key="IconConverter" />
    <!-- ==================== 工具箱字体资源 ==================== -->
    <FontFamily x:Key="ToolboxFontFamily">Segoe UI</FontFamily>
    <System:Double x:Key="ToolboxFontSizeSmall">10</System:Double>
    <System:Double x:Key="ToolboxFontSizeMedium">12</System:Double>
    <System:Double x:Key="ToolboxFontSizeLarge">14</System:Double>

    <!-- ==================== 工具栏样式 ==================== -->
    <Style x:Key="ToolboxToolbarStyle"
           TargetType="Border">
        <Setter Property="Background"
                Value="{DynamicResource SurfaceBrush}" />
        <Setter Property="CornerRadius"
                Value="14" />
        <Setter Property="Padding"
                Value="6,8" />
        <Setter Property="BorderThickness"
                Value="1" />
        <Setter Property="BorderBrush"
                Value="{DynamicResource BorderBrush}" />
        <Setter Property="Effect">
            <Setter.Value>
                <DropShadowEffect Color="{DynamicResource ShadowColor}"
                                  Opacity="0.12"
                                  BlurRadius="24"
                                  ShadowDepth="2"
                                  Direction="0" />
            </Setter.Value>
        </Setter>
    </Style>

    <!-- ==================== 工具按钮样式（纯图标）==================== -->
    <Style x:Key="ToolboxToolButtonStyle"
           TargetType="Button">
        <Setter Property="Background"
                Value="Transparent" />
        <Setter Property="BorderThickness"
                Value="0" />
        <Setter Property="Width"
                Value="54" />
        <Setter Property="Height"
                Value="54" />
        <Setter Property="Margin"
                Value="2" />
        <Setter Property="Cursor"
                Value="Hand" />
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="Button">
                    <Border x:Name="ButtonBorder"
                            Background="{TemplateBinding Background}"
                            CornerRadius="10"
                            Padding="0">
                        <ContentPresenter HorizontalAlignment="Center"
                                          VerticalAlignment="Center" />
                    </Border>
                    <ControlTemplate.Triggers>
                        <Trigger Property="IsMouseOver"
                                 Value="True">
                            <Setter TargetName="ButtonBorder"
                                    Property="Background">
                                <Setter.Value>
                                    <SolidColorBrush Color="{DynamicResource LightPrimaryColor}"
                                                     Opacity="0.3" />
                                </Setter.Value>
                            </Setter>
                        </Trigger>
                        <Trigger Property="IsPressed"
                                 Value="True">
                            <Setter TargetName="ButtonBorder"
                                    Property="Background">
                                <Setter.Value>
                                    <SolidColorBrush Color="{DynamicResource LightPrimaryColor}"
                                                     Opacity="0.5" />
                                </Setter.Value>
                            </Setter>
                            <Setter TargetName="ButtonBorder"
                                    Property="RenderTransform">
                                <Setter.Value>
                                    <ScaleTransform ScaleX="0.95"
                                                    ScaleY="0.95" />
                                </Setter.Value>
                            </Setter>
                        </Trigger>
                    </ControlTemplate.Triggers>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
        <Setter Property="RenderTransformOrigin"
                Value="0.5,0.5" />
    </Style>

    <!-- ==================== 面板样式（移除阴影效果）==================== -->
    <Style x:Key="ToolboxPanelStyle"
           TargetType="Border">
        <Setter Property="Background"
                Value="{DynamicResource SurfaceBrush}" />
        <Setter Property="BorderBrush"
                Value="{DynamicResource BorderBrush}" />
        <Setter Property="BorderThickness"
                Value="1" />
        <Setter Property="CornerRadius"
                Value="14" />
        <Setter Property="Padding"
                Value="18,16" />
        <Setter Property="MinWidth"
                Value="300" />
        <!-- 移除 Effect，阴影改由外层实现 -->
    </Style>

    <!-- ==================== 面板标题样式 ==================== -->
    <Style x:Key="ToolboxPanelTitleStyle"
           TargetType="TextBlock">
        <Setter Property="FontFamily"
                Value="{StaticResource ToolboxFontFamily}" />
        <Setter Property="FontSize"
                Value="16" />
        <Setter Property="FontWeight"
                Value="SemiBold" />
        <Setter Property="Foreground"
                Value="{DynamicResource PrimaryTextBrush}" />
        <Setter Property="Margin"
                Value="0,0,0,0" />
    </Style>

    <!-- ==================== 面板分隔线样式 ==================== -->
    <Style x:Key="ToolboxPanelSeparatorStyle"
           TargetType="Border">
        <Setter Property="Height"
                Value="1" />
        <Setter Property="Margin"
                Value="-18,12,-18,16" />
        <Setter Property="Background">
            <Setter.Value>
                <LinearGradientBrush StartPoint="0,0.5"
                                     EndPoint="1,0.5">
                    <GradientStop Color="Transparent"
                                  Offset="0" />
                    <GradientStop Color="{DynamicResource BorderColor}"
                                  Offset="0.15" />
                    <GradientStop Color="{DynamicResource BorderColor}"
                                  Offset="0.85" />
                    <GradientStop Color="Transparent"
                                  Offset="1" />
                </LinearGradientBrush>
            </Setter.Value>
        </Setter>
    </Style>

    <!-- ==================== 面板工具项按钮样式 ==================== -->
    <Style x:Key="ToolboxPanelItemStyle"
           TargetType="Button">
        <Setter Property="Background"
                Value="Transparent" />
        <Setter Property="BorderThickness"
                Value="0" />
        <Setter Property="Width"
                Value="88" />
        <Setter Property="Height"
                Value="96" />
        <Setter Property="Margin"
                Value="4" />
        <Setter Property="Cursor"
                Value="Hand" />
        <Setter Property="Foreground"
                Value="{DynamicResource PrimaryTextBrush}" />
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="Button">
                    <Border x:Name="ItemBorder"
                            Background="{TemplateBinding Background}"
                            CornerRadius="12"
                            Padding="8,10">
                        <ContentPresenter HorizontalAlignment="Center"
                                          VerticalAlignment="Center" />
                    </Border>
                    <ControlTemplate.Triggers>
                        <Trigger Property="IsMouseOver"
                                 Value="True">
                            <Setter TargetName="ItemBorder"
                                    Property="Background"
                                    Value="{DynamicResource SecondaryRegionBrush}" />
                            <Setter Property="Foreground"
                                    Value="{DynamicResource PrimaryBrush}" />
                        </Trigger>
                        <Trigger Property="IsPressed"
                                 Value="True">
                            <Setter TargetName="ItemBorder"
                                    Property="Background"
                                    Value="{DynamicResource ThirdlyRegionBrush}" />
                            <Setter TargetName="ItemBorder"
                                    Property="RenderTransform">
                                <Setter.Value>
                                    <ScaleTransform ScaleX="0.97"
                                                    ScaleY="0.97" />
                                </Setter.Value>
                            </Setter>
                        </Trigger>
                    </ControlTemplate.Triggers>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
        <Setter Property="RenderTransformOrigin"
                Value="0.5,0.5" />
    </Style>

    <!-- ==================== NodeToolBox 主样式 ==================== -->
    <Style TargetType="{x:Type controls:NodeToolBox}">
        <Setter Property="Background"
                Value="Transparent" />
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="{x:Type controls:NodeToolBox}">
                    <Border Background="{TemplateBinding Background}"
                            BorderThickness="0">
                        <Grid x:Name="RootGrid"
                              Margin="10,10,0,10">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            <!-- 主工具栏（纯图标）带视觉区分 -->
                            <Border x:Name="PART_MainToolbar"
                                    Grid.Column="0"
                                    Style="{DynamicResource ToolboxToolbarStyle}"
                                    VerticalAlignment="{TemplateBinding ToolbarAlignment}">
                                <ItemsControl ItemsSource="{TemplateBinding ItemsSource}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <StackPanel Orientation="Vertical"
                                                        Margin="0" />
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Button x:Name="CategoryButton"
                                                    Style="{DynamicResource ToolboxToolButtonStyle}"
                                                    ToolTip="{Binding Name}">
                                                <Button.Tag>
                                                    <Binding Path="IsSelected"
                                                             Converter="{StaticResource BooleanToStringConverter}" />
                                                </Button.Tag>
                                                <!-- 只显示图标，不显示文字 -->
                                                <Border x:Name="IconBorder"
                                                        Width="38"
                                                        Height="38"
                                                        CornerRadius="10"
                                                        HorizontalAlignment="Center"
                                                        VerticalAlignment="Center"
                                                        Opacity="0.4">
                                                    <Border.Background>
                                                        <RadialGradientBrush>
                                                            <GradientStop Color="{DynamicResource LightPrimaryColor}"
                                                                          Offset="0" />
                                                            <GradientStop Color="{DynamicResource PrimaryColor}"
                                                                          Offset="1" />
                                                        </RadialGradientBrush>
                                                    </Border.Background>
                                                    <fa:IconBlock x:Name="CategoryIcon"
                                                                  Icon="{Binding IconCode, Converter={StaticResource IconConverter}}"
                                                                  FontSize="20"
                                                                  HorizontalAlignment="Center"
                                                                  VerticalAlignment="Center"
                                                                  Foreground="{DynamicResource SecondaryTextBrush}" />
                                                </Border>
                                            </Button>
                                            <DataTemplate.Triggers>
                                                <!-- 选中状态 - 深色鲜艳渐变 -->
                                                <DataTrigger Binding="{Binding IsSelected}"
                                                             Value="True">
                                                    <Setter TargetName="IconBorder"
                                                            Property="Opacity"
                                                            Value="1" />
                                                    <Setter TargetName="IconBorder"
                                                            Property="Background">
                                                        <Setter.Value>
                                                            <LinearGradientBrush StartPoint="0,0"
                                                                                 EndPoint="1,1">
                                                                <GradientStop Color="{DynamicResource PrimaryColor}"
                                                                              Offset="0" />
                                                                <GradientStop Color="{DynamicResource DarkPrimaryColor}"
                                                                              Offset="1" />
                                                            </LinearGradientBrush>
                                                        </Setter.Value>
                                                    </Setter>
                                                    <Setter TargetName="IconBorder"
                                                            Property="Effect">
                                                        <Setter.Value>
                                                            <DropShadowEffect Color="{DynamicResource PrimaryColor}"
                                                                              Opacity="0.6"
                                                                              BlurRadius="18"
                                                                              ShadowDepth="0" />
                                                        </Setter.Value>
                                                    </Setter>
                                                    <Setter TargetName="CategoryIcon"
                                                            Property="Foreground"
                                                            Value="{DynamicResource ReverseTextBrush}" />
                                                </DataTrigger>
                                            </DataTemplate.Triggers>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </Border>

                            <!-- Popup 面板 -->
                            <Popup x:Name="PART_PopupPanel"
                                   Grid.Column="1"
                                   PlacementTarget="{Binding ElementName=PART_MainToolbar}"
                                   Placement="Right"
                                   HorizontalOffset="{TemplateBinding PanelOffsetX}"
                                   VerticalOffset="{TemplateBinding PanelOffsetY}"
                                   IsOpen="{Binding IsPanelVisible, RelativeSource={RelativeSource TemplatedParent}, Mode=TwoWay}"
                                   StaysOpen="True"
                                   AllowsTransparency="True"
                                   PopupAnimation="Fade">

                                <!-- 让弹出面板仅根据内容自适应大小，避免 400x400 的透明区域遮挡画布左侧鼠标事件 -->
                                <Grid Margin="10">

                                        <Border Background="{DynamicResource PrimaryTextBrush}"
                                                CornerRadius="14"
                                                Margin="0,8,8,12"
                                                IsHitTestVisible="False">
                                           

                                            <Border.Effect>
                                                <DropShadowEffect BlurRadius="20"
                                                                  ShadowDepth="4"
                                                                  Opacity="0.5"
                                                                  Direction="0"
                                                                  Color="{DynamicResource ShadowColor}" />
                                            </Border.Effect>
                                        </Border>

                    

                                        <Border x:Name="PART_ToolPanel"
                                                Style="{DynamicResource ToolboxPanelStyle}"
                                                MaxHeight="{TemplateBinding PanelMaxHeight}"
                                                ClipToBounds="True"
                                                IsHitTestVisible="True">

                                            <StackPanel>
                                                <!-- 标题区 -->
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto" />
                                                        <ColumnDefinition Width="*" />
                                                    </Grid.ColumnDefinitions>

                                                    <!-- 装饰性色块 - 深色渐变 -->
                                                    <Border Width="5"
                                                            Height="20"
                                                            CornerRadius="2.5"
                                                            Margin="0,0,10,0"
                                                            VerticalAlignment="Center">
                                                        <Border.Background>
                                                            <LinearGradientBrush StartPoint="0,0"
                                                                                 EndPoint="0,1">
                                                                <GradientStop Color="{DynamicResource PrimaryColor}"
                                                                              Offset="0" />
                                                                <GradientStop Color="{DynamicResource DarkPrimaryColor}"
                                                                              Offset="1" />
                                                            </LinearGradientBrush>
                                                        </Border.Background>
                                                        <Border.Effect>
                                                            <DropShadowEffect Color="{DynamicResource PrimaryColor}"
                                                                              Opacity="0.4"
                                                                              BlurRadius="8"
                                                                              ShadowDepth="0" />
                                                        </Border.Effect>
                                                    </Border>

                                                    <TextBlock Grid.Column="1"
                                                               Text="{Binding CurrentCategory.Name, RelativeSource={RelativeSource TemplatedParent}}"
                                                               Style="{DynamicResource ToolboxPanelTitleStyle}"
                                                               VerticalAlignment="Center" />
                                                </Grid>

                                                <Border Style="{DynamicResource ToolboxPanelSeparatorStyle}" />

                                                <!-- 工具项区域 -->
                                                <ScrollViewer x:Name="PART_ToolsScrollViewer"
                                                              MaxHeight="{TemplateBinding ToolsMaxHeight}"
                                                              HorizontalScrollBarVisibility="Disabled"
                                                              VerticalScrollBarVisibility="Auto"
                                                              Background="Transparent"
                                                              BorderThickness="0"
                                                              Padding="0">
                                                    <ItemsControl x:Name="PART_ToolsItemsControl"
                                                                  ItemsSource="{Binding CurrentCategory.Tools, RelativeSource={RelativeSource TemplatedParent}}">
                                                        <ItemsControl.ItemsPanel>
                                                            <ItemsPanelTemplate>
                                                                <UniformGrid x:Name="PART_ToolsUniformGrid" />
                                                            </ItemsPanelTemplate>
                                                        </ItemsControl.ItemsPanel>
                                                        <ItemsControl.ItemTemplate>
                                                            <DataTemplate>
                                                                <Button Style="{DynamicResource ToolboxPanelItemStyle}"
                                                                        Tag="{Binding CurrentCategory.Name, RelativeSource={RelativeSource AncestorType=controls:NodeToolBox}}"
                                                                        ToolTip="{Binding Name}">
                                                                    <StackPanel Orientation="Vertical"
                                                                                HorizontalAlignment="Center"
                                                                                VerticalAlignment="Center"
                                                                                Margin="0,2">
                                                                        <!-- 图标容器 - 加深渐变色 -->
                                                                        <Border x:Name="ToolIconContainer"
                                                                                Width="44"
                                                                                Height="44"
                                                                                HorizontalAlignment="Center"
                                                                                VerticalAlignment="Center"
                                                                                CornerRadius="11"
                                                                                Margin="0,0,0,8">
                                                                            <Border.Background>
                                                                                <LinearGradientBrush StartPoint="0,0"
                                                                                                     EndPoint="1,1">
                                                                                    <!-- 左上角：深色 -->
                                                                                    <GradientStop Color="{Binding CurrentCategory.CategoryColor.Color, RelativeSource={RelativeSource AncestorType=controls:NodeToolBox}}"
                                                                                                  Offset="0" />
                                                                                    <!-- 中间：深色为主 -->
                                                                                    <GradientStop Color="{Binding CurrentCategory.CategoryColor.Color, RelativeSource={RelativeSource AncestorType=controls:NodeToolBox}}"
                                                                                                  Offset="0.7" />
                                                                                    <!-- 右下角：保持深色（不使用浅色）-->
                                                                                    <GradientStop Color="{Binding CurrentCategory.CategoryColor.Color, RelativeSource={RelativeSource AncestorType=controls:NodeToolBox}}"
                                                                                                  Offset="1" />
                                                                                </LinearGradientBrush>
                                                                            </Border.Background>
                                                                            <Border.Effect>
                                                                                <DropShadowEffect Color="{Binding CurrentCategory.CategoryColor.Color, RelativeSource={RelativeSource AncestorType=controls:NodeToolBox}}"
                                                                                                  Opacity="0.6"
                                                                                                  BlurRadius="16"
                                                                                                  ShadowDepth="6"
                                                                                                  Direction="270" />
                                                                            </Border.Effect>

                                                                            <fa:IconBlock Icon="{Binding IconCode, Converter={StaticResource IconConverter}}"
                                                                                          FontSize="22"
                                                                                          HorizontalAlignment="Center"
                                                                                          VerticalAlignment="Center"
                                                                                          Foreground="White" />
                                                                        </Border>

                                                                        <!-- 文字（仅面板显示）-->
                                                                        <TextBlock Text="{Binding Name}"
                                                                                   FontFamily="{StaticResource ToolboxFontFamily}"
                                                                                   FontSize="11"
                                                                                   FontWeight="Medium"
                                                                                   Foreground="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"
                                                                                   HorizontalAlignment="Center"
                                                                                   TextAlignment="Center"
                                                                                   TextWrapping="Wrap"
                                                                                   TextTrimming="CharacterEllipsis"
                                                                                   MaxWidth="76"
                                                                                   LineHeight="15"
                                                                                   LineStackingStrategy="BlockLineHeight" />
                                                                    </StackPanel>
                                                                </Button>
                                                            </DataTemplate>
                                                        </ItemsControl.ItemTemplate>
                                                    </ItemsControl>
                                                </ScrollViewer>
                                            </StackPanel>
                                        </Border>
                                </Grid>
                            </Popup>
                        </Grid>
                    </Border>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>

</ResourceDictionary>