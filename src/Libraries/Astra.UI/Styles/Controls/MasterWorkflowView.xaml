<UserControl x:Class="Astra.UI.Styles.Controls.MasterWorkflowView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Astra.UI.Styles.Controls"
             xmlns:converters="clr-namespace:Astra.UI.Converters"
             xmlns:controls="clr-namespace:Astra.UI.Controls"
             xmlns:viewmodels="clr-namespace:Astra.UI.ViewModels"
             xmlns:models="clr-namespace:Astra.UI.Models"
             xmlns:nodeModels="clr-namespace:Astra.Core.Nodes.Models;assembly=Astra.Core"
            
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800">
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        <converters:StringFallbackConverter x:Key="StringFallbackConverter" />
        <converters:ExecutionResultToTimeConverter x:Key="ExecutionResultToTimeConverter" />

        <!-- WorkflowReferenceNode 特殊样式模板（使用 WorkflowReferenceNodeControl 控件） -->
        <DataTemplate x:Key="WorkflowReferenceNodeTemplate">
            <controls:WorkflowReferenceNodeControl>
                <controls:WorkflowReferenceNodeControl.SubWorkflowName>
                    <MultiBinding Converter="{StaticResource StringFallbackConverter}">
                        <Binding Path="SubWorkflowName" />
                        <Binding Path="Name" />
                    </MultiBinding>
                </controls:WorkflowReferenceNodeControl.SubWorkflowName>
                <controls:WorkflowReferenceNodeControl.ExecutionCount>0</controls:WorkflowReferenceNodeControl.ExecutionCount>
                <controls:WorkflowReferenceNodeControl.ExecutionTime>0.00ms</controls:WorkflowReferenceNodeControl.ExecutionTime>
                <controls:WorkflowReferenceNodeControl.IsEnabled>
                    <Binding Path="IsEnabled"
                             Mode="TwoWay" />
                </controls:WorkflowReferenceNodeControl.IsEnabled>
                <controls:WorkflowReferenceNodeControl.IsSelected>
                    <Binding Path="IsSelected"
                             Mode="TwoWay" />
                </controls:WorkflowReferenceNodeControl.IsSelected>
            </controls:WorkflowReferenceNodeControl>
        </DataTemplate>

        <!-- 默认节点模板（使用 NodeControl） -->
        <DataTemplate x:Key="DefaultNodeTemplate">
            <controls:NodeControl Title="{Binding Name, Mode=TwoWay, FallbackValue='节点'}"
                                  Status="{Binding ExecutionState, FallbackValue={x:Static nodeModels:NodeExecutionState.Idle}}"
                                  ExecutionTime="{Binding LastExecutionResult, Converter={StaticResource ExecutionResultToTimeConverter}, FallbackValue='0 s'}"
                                  IsSelected="{Binding IsSelected, Mode=TwoWay}" />
        </DataTemplate>

        <!-- 节点模板选择器 -->
        <!-- 主流程模板选择器（包含 WorkflowReferenceNode 特殊样式） -->
        <converters:NodeTypeToDataTemplateSelector x:Key="MasterNodeTemplateSelector"
                                                   WorkflowReferenceNodeTemplate="{StaticResource WorkflowReferenceNodeTemplate}"
                                                   DefaultNodeTemplate="{StaticResource DefaultNodeTemplate}" />

        <!-- 子流程模板选择器（只使用默认模板，不包含 WorkflowReferenceNode 特殊样式） -->
        <converters:NodeTypeToDataTemplateSelector x:Key="SubNodeTemplateSelector"
                                                   DefaultNodeTemplate="{StaticResource DefaultNodeTemplate}" />

        <!-- 根据流程类型选择模板选择器的转换器 -->
        <converters:WorkflowTypeToTemplateSelectorConverter x:Key="WorkflowTypeToTemplateSelectorConverter"
                                                            MasterTemplateSelector="{StaticResource MasterNodeTemplateSelector}"
                                                            SubTemplateSelector="{StaticResource SubNodeTemplateSelector}" />
    </UserControl.Resources>

    <Grid>
        <!-- 主流程编辑区域 -->
        <controls:FlowEditor x:Name="MasterWorkflowEditor"
                             ClipToBounds="True"
                             ToolBoxItemsSource="{x:Null}"
                             CanvasItemsSource="{Binding MasterWorkflowTab.Nodes, Mode=OneWay}"
                             EdgeItemsSource="{Binding MasterWorkflowTab.Edges, Mode=OneWay}"
                             ItemTemplateSelector="{Binding MasterWorkflowTab.Type, Converter={StaticResource WorkflowTypeToTemplateSelectorConverter}}"
                             IsToolBoxVisible="False"
                             AllowDrop="False"
                             Loaded="MasterWorkflowEditor_Loaded" />
    </Grid>
</UserControl>
